--- 
- name: create data directory for usb device
  become: yes
  file:
    path: '/mnt/qubiusb'
    state: directory   

- name: mount data filesystem
  become: yes
  command: > 
    "mount {{ usb_device }}3 /mnt/qubiusb/"

- name: create boot directory for usb device
  become: yes
  file:
    path: '/mnt/qubiusb/boot'
    state: directory 

- name: mount legacy boot filesystem
  become: yes
  command: > 
    "mount {{ usb_device }}1 /mnt/qubiusb/boot/"

- name: create efi boot directory for usb device
  become: yes
  file:
    path: '/mnt/qubiusb/boot/efi'
    state: directory 

- name: mount legacy boot filesystem
  become: yes
  command: > 
    "mount {{ usb_device }}2 /mnt/qubiusb/boot/efi"

- name: install legacy grub filesystem 
  become: yes
  command: >
    "grub2-install 
    --boot-directory=/mnt/qubiusb/boot
    --target=i386-pc 
    --recheck 
    {{ usb_device }}" 

- name: install efi grub filesystem 
  become: yes
  command: >
    "grub2-install 
    --boot-directory=/mnt/qubiusb/boot 
    --efi-directory=/mnt/qubiusb/boot/efi 
    --target=x86_64-efi --bootloader-id=qubinode 
    --removable -v {{ usb_device }}"

- name: create grub config file
  become: yes
  command: >
    grub2-mkconfig -o /mnt/qubiusb/boot/grub2/grub.cfg
    
- name: get the FSSUID for the usb device
  become: yes
  command: >
    "lsblk -f {{ usb_device }} | grep xfs"
  register: dev_fsuuid

- name: deploy qubinode custom grub file
  become: yes 
  template:
    src: grub2.conf.j2
    dest: '/mnt/qubiusb/boot/grub2/grub.cfg'
    mode: '0644'

- name: deploy qubinode custom kickstart file
  become: yes 
  template:
    src: qubinode_rhel76.ks.j2
    dest: '/mnt/qubiusb/qubinode-rhel7.6.ks'
    mode: '0644'

- name: copy RHEL 7.6 iso file to usb device
  become: yes
  copy:
    src: "{{ local_rhel_iso }}"
    dest: '/mnt/qubiusb'
    mode: '0644'

- name: unmount legacy boot filesystem
  become: yes
  command: > 
    "unmount {{ usb_device }}2 /mnt/qubiusb/boot/efi"

- name: unmount legacy boot filesystem
  become: yes
  command: > 
    "umount {{ usb_device }}1 /mnt/qubiusb/boot/"

- name: unmount data filesystem
  become: yes
  command: > 
    "umount {{ usb_device }}3 /mnt/qubiusb/"      

